import { nextTick } from 'vue';

function usePinceauRuntimeDebug(tokensHelperConfig) {
  let nextTickGroup = [];
  let nextTickCalled = false;
  const TOKEN_NOT_FOUND_MESSAGE = (path, options) => {
    const { loc } = options;
    const message = [
      `\u{1F511} ${path}`
    ];
    if (loc?.file) {
      message.push("");
      message.push(`\u{1F517} ${loc.file}`);
    }
    if (loc?.type) {
      message.push("");
      message.push(`\u2753 Missing token inside a ${loc.type === "v" ? "variant" : "computed style or CSS prop"}.`);
    }
    nextTickGroup.push(message.join("\n"));
    if (!nextTickCalled) {
      nextTick(() => {
        const title = "\u{1F58C}\uFE0F Pinceau `runtime` encountered some errors!";
        if (import.meta.hot) {
          console.groupCollapsed(title);
        } else {
          console.log(title);
        }
        nextTickGroup.forEach((m) => {
          if (!import.meta.hot && process.server) {
            console.log("\n");
          }
          console.log(m);
          if (!import.meta.hot && process.server) {
            console.log("\n");
          }
        });
        console.log("\u203C\uFE0F This warning will be hidden from production and can be disabled using `dev: false` option.");
        if (import.meta.hot) {
          console.groupEnd();
        }
      });
      nextTickCalled = true;
    }
  };
  if (import.meta.hot) {
    import.meta.hot.on("vite:afterUpdate", () => {
      nextTickGroup = [];
      nextTickCalled = false;
    });
  }
  tokensHelperConfig.onNotFound = TOKEN_NOT_FOUND_MESSAGE;
}

export { usePinceauRuntimeDebug };
