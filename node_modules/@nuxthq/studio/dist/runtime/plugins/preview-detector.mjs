import { defineNuxtPlugin, useState, refreshNuxtData, useCookie, useRoute, useRuntimeConfig } from "#imports";
export default defineNuxtPlugin((nuxtApp) => {
  const contentStorage = useState("client-db", () => null);
  const runtimeConfig = useRuntimeConfig().public.studio || {};
  const route = useRoute();
  const previewToken = useCookie("previewToken", { sameSite: "none", secure: true });
  async function initializePreview() {
    nuxtApp.hook("page:finish", () => {
      refreshNuxtData();
      nuxtApp.hook("content:storage", (storage) => {
        contentStorage.value = storage;
      });
    });
    const useStudio = await import("../composables/useStudio").then((m) => m.useStudio);
    const { mountPreviewUI } = useStudio();
    mountPreviewUI(contentStorage);
  }
  if (runtimeConfig.apiURL) {
    if (Object.prototype.hasOwnProperty.call(route.query, "preview") && !route.query.preview) {
      return false;
    }
    if (!route.query.preview && !previewToken.value) {
      return false;
    }
    if (route.query.preview && previewToken.value !== route.query.preview) {
      previewToken.value = String(route.query.preview);
    }
    nuxtApp.hook("app:mounted", async () => {
      await initializePreview();
    });
  }
});
